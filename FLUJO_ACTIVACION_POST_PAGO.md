# Flujo de Activaci√≥n Post-Pago - Documentaci√≥n T√©cnica

**Fecha de implementaci√≥n:** 22 de Octubre de 2025
**Versi√≥n:** 1.0
**Autor:** Sistema de IA - Claude Code

---

## üìã Resumen Ejecutivo

Se ha implementado un sistema robusto de activaci√≥n post-pago que resuelve el problema de usuarios nuevos que no pod√≠an hacer login inmediatamente despu√©s de completar su pago en Stripe.

### Problema Identificado

El flujo anterior ten√≠a una brecha cr√≠tica:

1. Usuario nuevo accede a PricingPage y selecciona un plan
2. Completa el pago en Stripe
3. Es redirigido a PaymentSuccess
4. **PROBLEMA:** No puede hacer login porque el webhook de Stripe a√∫n no ha creado su registro en `user_profiles`
5. El flujo de OTP requiere que el usuario exista en la base de datos

### Soluci√≥n Implementada

Se ha creado un sistema de verificaci√≥n activa que:

1. Mantiene al usuario en una pantalla de procesamiento din√°mica con feedback visual continuo
2. Verifica autom√°ticamente cada 3 segundos si su cuenta ya fue creada por el webhook de Stripe
3. Una vez confirmada la activaci√≥n, redirige al login normal con el email pre-rellenado
4. Maneja timeouts y errores con opciones de recuperaci√≥n
5. Usa localStorage para mantener estado entre recargas de p√°gina

---

## üèóÔ∏è Arquitectura de la Soluci√≥n

### Componentes Nuevos

#### 1. Edge Function: `check-user-activation-status`

**Ubicaci√≥n:** `/supabase/functions/check-user-activation-status/index.ts`

**Prop√≥sito:** Verificar si un usuario ha sido activado completamente en Supabase.

**Endpoint:** `GET /functions/v1/check-user-activation-status`

**Query Parameters:**
- `email` (requerido): Email del usuario a verificar
- `session_id` (opcional): Session ID de Stripe para logging

**Respuestas posibles:**

```typescript
// Usuario a√∫n no existe en user_profiles
{
  status: 'pending',
  message: 'Usuario a√∫n no activado...',
  email: 'user@example.com'
}

// Usuario existe y est√° activo
{
  status: 'active',
  message: 'Usuario activado correctamente',
  user: {
    id: 'uuid',
    email: 'user@example.com',
    subscription_tier: 2,
    max_devices: 3,
    subscription_end_date: '2026-10-22T...'
  }
}

// Error en la verificaci√≥n
{
  status: 'error',
  error: 'Error al verificar usuario',
  details: '...'
}
```

**Logging:** Cada verificaci√≥n se registra en `auth_logs` con los siguientes `event_type`:
- `activation_check_pending`: Usuario a√∫n no existe
- `activation_check_success`: Usuario activado correctamente
- `activation_check_incomplete`: Usuario existe pero falta data de Stripe
- `activation_check_error`: Error en la verificaci√≥n

---

### Componentes Modificados

#### 2. `create-checkout-session` (Edge Function)

**Cambio:** Se agreg√≥ el email como query parameter en la `success_url` de Stripe.

**Antes:**
```typescript
success_url: `${origin}${basePath}/payment-success?session_id={CHECKOUT_SESSION_ID}`
```

**Despu√©s:**
```typescript
success_url: `${origin}${basePath}/payment-success?session_id={CHECKOUT_SESSION_ID}&email=${encodeURIComponent(normalizedEmail)}`
```

**Motivo:** Permite que `PaymentSuccess` conozca el email inmediatamente sin necesidad de consultar la API de Stripe.

---

#### 3. `PaymentSuccess.tsx` (Componente React)

**Ubicaci√≥n:** `/src/components/PaymentSuccess.tsx`

**Cambio:** Completamente reescrito para implementar verificaci√≥n activa.

**Caracter√≠sticas principales:**

##### Estados visuales progresivos:

1. **Fase 1 (0-30s):** "Procesando tu pago con Stripe..." - 25% progreso
2. **Fase 2 (30-60s):** "Confirmando pago y creando tu cuenta..." - 50% progreso
3. **Fase 3 (60-90s):** "Activando tu suscripci√≥n..." - 75% progreso
4. **Fase 4 (90-120s):** "Casi listo, √∫ltimos ajustes..." - 90% progreso

##### Mensajes motivacionales rotativos:
- Cambian cada 8 segundos
- Mantienen al usuario informado sin generar ansiedad
- Ejemplos: "Todo va bien...", "Configurando tu suscripci√≥n...", "Preparando tus dispositivos..."

##### Sistema de polling:
- Verifica estado cada 3 segundos
- M√°ximo 120 segundos de espera
- Contador visible en pantalla

##### Manejo de estados:

**Estado: `pending`** (verificando)
- Muestra spinner animado
- Barra de progreso con gradiente azul-verde
- Mensajes de fase seg√∫n tiempo transcurrido
- Contador de tiempo visible

**Estado: `active`** (cuenta activada)
- Icono de check verde con animaci√≥n bounce
- Mensaje: "¬°Cuenta activada!"
- Muestra detalles de la suscripci√≥n (tier, dispositivos)
- Redirige autom√°ticamente al login en 2 segundos

**Estado: `timeout`** (m√°s de 120 segundos)
- Icono de alerta naranja
- Banner verde confirmando que el pago fue exitoso
- Muestra session_id y email para soporte
- 3 opciones:
  1. Reintentar verificaci√≥n
  2. Ir al login (intentar en 5 min)
  3. Contactar soporte (pre-rellena email con datos)

**Estado: `error`** (error en verificaci√≥n)
- Similar a timeout pero con mensaje de error
- Mismas opciones de recuperaci√≥n

##### LocalStorage:

**`pending_activation`:**
```json
{
  "email": "user@example.com",
  "sessionId": "cs_test_...",
  "timestamp": "2025-10-22T12:00:00.000Z"
}
```
- Se guarda al llegar a PaymentSuccess
- Se elimina al confirmar activaci√≥n
- Permite recuperar el estado si el usuario recarga la p√°gina

**`recently_activated`:**
```json
{
  "email": "user@example.com",
  "timestamp": "2025-10-22T12:05:00.000Z"
}
```
- Se guarda al confirmar activaci√≥n exitosa
- Expira en 5 minutos
- Usado por LoginContainer para mostrar banner de bienvenida

---

#### 4. `LoginContainer.tsx` (Componente React)

**Ubicaci√≥n:** `/src/components/auth/LoginContainer.tsx`

**Cambios:**

1. **Detecci√≥n de activaci√≥n reciente:**
```typescript
useEffect(() => {
  const recentlyActivatedStr = localStorage.getItem('recently_activated');
  if (recentlyActivatedStr) {
    const recentlyActivated = JSON.parse(recentlyActivatedStr);
    const activationTime = new Date(recentlyActivated.timestamp).getTime();
    const currentTime = new Date().getTime();
    const fiveMinutesInMs = 5 * 60 * 1000;

    if (currentTime - activationTime < fiveMinutesInMs) {
      setRecentlyActivatedEmail(recentlyActivated.email);
      setShowActivationBanner(true);

      setTimeout(() => setShowActivationBanner(false), 8000);
    } else {
      localStorage.removeItem('recently_activated');
    }
  }
}, []);
```

2. **Banner de bienvenida animado:**
- Fondo verde con borde destacado
- Icono CheckCircle
- Mensaje: "¬°Bienvenido! Tu cuenta est√° lista"
- Se auto-oculta despu√©s de 8 segundos
- Bot√≥n de cerrar manual

3. **Pre-relleno del email:**
- El campo email se inicializa con el email de activaci√≥n reciente
- El usuario solo necesita hacer click en "Enviar c√≥digo de acceso"

---

#### 5. `EmailInputForm.tsx` (Componente React)

**Ubicaci√≥n:** `/src/components/auth/EmailInputForm.tsx`

**Cambio:** Se agreg√≥ soporte para email inicial.

```typescript
interface EmailInputFormProps {
  onSubmit: (email: string) => Promise<void>;
  initialEmail?: string; // NUEVO
}

export function EmailInputForm({ onSubmit, initialEmail = '' }: EmailInputFormProps) {
  const [email, setEmail] = useState(initialEmail); // Usa initialEmail
  // ...
}
```

---

## üîÑ Flujo Completo del Usuario

### Caso 1: Usuario Nuevo (Primera Suscripci√≥n)

```
1. Usuario accede sin cuenta
   ‚îî‚îÄ> LoginContainer detecta que no est√° autenticado
   ‚îî‚îÄ> Muestra UnregisteredUserView

2. Usuario hace click en "Ver Planes y Precios"
   ‚îî‚îÄ> Redirige a PricingPage con su email

3. Usuario selecciona un plan (ej: Tier 2, Anual)
   ‚îî‚îÄ> PricingPage llama a create-checkout-session
   ‚îî‚îÄ> create-checkout-session crea customer en Stripe
   ‚îî‚îÄ> Redirige a Stripe Checkout

4. Usuario completa el pago en Stripe
   ‚îî‚îÄ> Stripe procesa el pago exitosamente
   ‚îî‚îÄ> Stripe redirige a: /payment-success?session_id=cs_xxx&email=user@example.com

5. PaymentSuccess inicia verificaci√≥n activa
   ‚îî‚îÄ> Guarda pending_activation en localStorage
   ‚îî‚îÄ> Muestra pantalla de procesamiento con progreso
   ‚îî‚îÄ> Inicia polling cada 3s a check-user-activation-status

6. En paralelo: Stripe env√≠a webhook
   ‚îî‚îÄ> Webhook crea auth.users (si no existe)
   ‚îî‚îÄ> Webhook inserta registro en user_profiles
   ‚îî‚îÄ> Estado: subscription_status = 'active'
   ‚îî‚îÄ> Incluye: stripe_customer_id, stripe_subscription_id
   ‚îî‚îÄ> Log: stripe_new_user_created

7. PaymentSuccess detecta activaci√≥n (t√≠picamente 10-30s)
   ‚îî‚îÄ> check-user-activation-status retorna status: 'active'
   ‚îî‚îÄ> Muestra pantalla de √©xito con animaci√≥n
   ‚îî‚îÄ> Guarda recently_activated en localStorage
   ‚îî‚îÄ> Elimina pending_activation
   ‚îî‚îÄ> Redirige a "/" en 2 segundos

8. LoginContainer detecta activaci√≥n reciente
   ‚îî‚îÄ> Muestra banner verde de bienvenida
   ‚îî‚îÄ> Pre-rellena campo email
   ‚îî‚îÄ> Usuario hace click en "Enviar c√≥digo de acceso"

9. Usuario recibe c√≥digo OTP por email
   ‚îî‚îÄ> Introduce c√≥digo en CodeVerificationForm
   ‚îî‚îÄ> Sistema valida c√≥digo
   ‚îî‚îÄ> Crea sesi√≥n en user_sessions
   ‚îî‚îÄ> Redirige a calculadora (TariffCalculator)

10. ¬°Usuario puede empezar a usar la aplicaci√≥n!
```

### Caso 2: Usuario Existente (Renovaci√≥n)

```
1. Usuario autenticado ve que su suscripci√≥n expir√≥
   ‚îî‚îÄ> App.tsx detecta !canAccessCalculator(userData)
   ‚îî‚îÄ> Muestra PricingPage con su email

2. Usuario selecciona plan de renovaci√≥n
   ‚îî‚îÄ> create-checkout-session usa stripe_customer_id existente
   ‚îî‚îÄ> Redirige a Stripe Checkout

3. Usuario completa el pago
   ‚îî‚îÄ> Similar a flujo de nuevo usuario pero...
   ‚îî‚îÄ> Webhook actualiza user_profiles existente (no inserta)
   ‚îî‚îÄ> Log: stripe_user_renewed

4. PaymentSuccess detecta activaci√≥n m√°s r√°pido (usuario ya existe)
   ‚îî‚îÄ> T√≠picamente 5-15 segundos
   ‚îî‚îÄ> Redirige a login

5. Usuario hace login con OTP
   ‚îî‚îÄ> Sesi√≥n anterior podr√≠a estar activa
   ‚îî‚îÄ> verify-login-code renueva sesi√≥n existente o crea nueva

6. Usuario accede a calculadora con suscripci√≥n renovada
```

### Caso 3: Timeout (m√°s de 120 segundos)

```
1. Usuario completa pago pero webhook tarda demasiado
   ‚îî‚îÄ> PaymentSuccess alcanza 120 segundos
   ‚îî‚îÄ> Muestra pantalla de timeout

2. Usuario tiene 3 opciones:

   A. Reintentar verificaci√≥n
      ‚îî‚îÄ> Resetea contador y vuelve a verificar

   B. Ir al login (intentar en 5 min)
      ‚îî‚îÄ> Guarda recently_activated
      ‚îî‚îÄ> Redirige a login
      ‚îî‚îÄ> Usuario puede intentar hacer login despu√©s

   C. Contactar soporte
      ‚îî‚îÄ> Abre cliente de email con datos pre-rellenados:
          - Email del usuario
          - Session ID de Stripe
          - Timestamp
      ‚îî‚îÄ> Soporte puede verificar manualmente el pago
```

---

## üóÑÔ∏è Cambios en Base de Datos

**No se requirieron cambios en el esquema de base de datos.**

El sistema utiliza las tablas existentes:
- `user_profiles`: Almacena datos de suscripci√≥n
- `auth_logs`: Registra todos los eventos de verificaci√≥n
- `user_sessions`: Gestiona sesiones de dispositivos

---

## üìä Logging y Auditor√≠a

Todos los eventos se registran en `auth_logs` para trazabilidad completa:

| Event Type | Descripci√≥n | Cu√°ndo se registra |
|------------|-------------|-------------------|
| `checkout_session_created` | Sesi√≥n de checkout creada | create-checkout-session |
| `activation_check_pending` | Usuario a√∫n no existe | check-user-activation-status |
| `activation_check_success` | Usuario activado | check-user-activation-status |
| `activation_check_incomplete` | Usuario existe sin Stripe data | check-user-activation-status |
| `activation_check_error` | Error en verificaci√≥n | check-user-activation-status |
| `stripe_new_user_created` | Nuevo usuario desde webhook | stripe-webhook |
| `stripe_user_renewed` | Renovaci√≥n desde webhook | stripe-webhook |
| `stripe_webhook_update_success` | Profile actualizado correctamente | stripe-webhook |
| `stripe_webhook_update_failed` | Error al actualizar profile | stripe-webhook |

---

## üß™ Testing

### Escenarios de Prueba

#### 1. Usuario Nuevo - Flujo Normal
- ‚úÖ Crear cuenta con email nuevo
- ‚úÖ Completar pago en Stripe test mode
- ‚úÖ Verificar que PaymentSuccess muestra progreso
- ‚úÖ Confirmar que activa en menos de 30s
- ‚úÖ Verificar banner de bienvenida en login
- ‚úÖ Hacer login con OTP

#### 2. Usuario Existente - Renovaci√≥n
- ‚úÖ Usar cuenta con suscripci√≥n expirada
- ‚úÖ Renovar suscripci√≥n
- ‚úÖ Verificar actualizaci√≥n m√°s r√°pida
- ‚úÖ Confirmar que datos de Stripe se actualizan

#### 3. Manejo de Errores
- ‚ö†Ô∏è Simular timeout (esperar 120s)
- ‚ö†Ô∏è Verificar opciones de recuperaci√≥n
- ‚ö†Ô∏è Probar "Reintentar verificaci√≥n"
- ‚ö†Ô∏è Probar "Ir al login"
- ‚ö†Ô∏è Probar "Contactar soporte"

#### 4. LocalStorage
- ‚úÖ Cerrar navegador durante verificaci√≥n
- ‚úÖ Reabrir y verificar que contin√∫a
- ‚úÖ Verificar que pending_activation se limpia
- ‚úÖ Verificar que recently_activated expira en 5 min

#### 5. Webhook de Stripe
- ‚úÖ Verificar que crea usuario nuevo correctamente
- ‚úÖ Verificar que actualiza usuario existente
- ‚úÖ Confirmar logs en auth_logs
- ‚úÖ Verificar reintentos con updateUserProfileWithRetry

---

## üîê Seguridad

### Consideraciones

1. **Email Validation:**
   - create-checkout-session valida dominio @gls-spain.es
   - Excepciones: dcprats@gmail.com, damaso.prats@logicalogistica.com

2. **Autenticaci√≥n:**
   - check-user-activation-status requiere ANON_KEY
   - Service role usado solo en servidor (Edge Functions)

3. **Row Level Security (RLS):**
   - user_profiles: Usuarios solo ven su propio perfil
   - Pol√≠ticas existentes no fueron modificadas

4. **Datos sensibles:**
   - Session ID de Stripe solo se usa para logging
   - No se expone informaci√≥n de tarjetas de cr√©dito
   - Emails se normalizan (lowercase, trim)

---

## üöÄ Deployment

### Archivos Modificados

```
‚úÖ /supabase/functions/check-user-activation-status/index.ts (NUEVO)
‚úÖ /supabase/functions/create-checkout-session/index.ts (MODIFICADO)
‚úÖ /src/components/PaymentSuccess.tsx (REESCRITO)
‚úÖ /src/components/auth/LoginContainer.tsx (MODIFICADO)
‚úÖ /src/components/auth/EmailInputForm.tsx (MODIFICADO)
```

### Pasos de Deployment

1. **Deploy Edge Function:**
```bash
# Se despliega autom√°ticamente via MCP tool
# mcp__supabase__deploy_edge_function
```

2. **Build Frontend:**
```bash
npm run build
```

3. **Verificar Environment Variables:**
- ‚úÖ `VITE_SUPABASE_URL`
- ‚úÖ `VITE_SUPABASE_ANON_KEY`
- ‚úÖ `STRIPE_SECRET_KEY`
- ‚úÖ `STRIPE_WEBHOOK_SECRET`

---

## üìù Notas Importantes

### Webhook de Stripe

El webhook actual (`stripe-webhook/index.ts`) **NO fue modificado** porque:

1. ‚úÖ Ya maneja correctamente la creaci√≥n de nuevos usuarios (l√≠neas 296-359)
2. ‚úÖ Incluye sistema de reintentos con `updateUserProfileWithRetry`
3. ‚úÖ Registra logs detallados en auth_logs
4. ‚úÖ Funciona tanto para nuevos usuarios como renovaciones

**El √∫nico problema era en el frontend**, no en el webhook.

### Flujo de OTP

El sistema de autenticaci√≥n por OTP **NO fue modificado** porque:

1. ‚úÖ Es robusto y funciona correctamente
2. ‚úÖ Sensibilidad alta - no se debe tocar sin necesidad
3. ‚úÖ Solo se agreg√≥ pre-relleno de email, no l√≥gica de verificaci√≥n

### Backwards Compatibility

‚úÖ **Totalmente compatible con usuarios existentes**

- LoginContainer mantiene flujo original si no hay activaci√≥n reciente
- EmailInputForm funciona sin initialEmail (usa string vac√≠o por defecto)
- PaymentSuccess solo act√∫a si hay email en URL (nuevos pagos)

---

## üêõ Troubleshooting

### Problema: Usuario no se activa despu√©s de 120s

**Posibles causas:**
1. Webhook de Stripe no est√° llegando
2. Error en createUser de Supabase
3. Error en insert de user_profiles

**Soluci√≥n:**
1. Revisar logs de Stripe Dashboard > Webhooks
2. Revisar logs de auth_logs en Supabase
3. Verificar que STRIPE_WEBHOOK_SECRET est√° configurado
4. Usuario puede intentar login en 5-10 minutos

### Problema: Banner de bienvenida no aparece

**Posibles causas:**
1. localStorage bloqueado por navegador
2. recently_activated expir√≥ (m√°s de 5 min)
3. Usuario limpi√≥ localStorage

**Soluci√≥n:**
- No es cr√≠tico, el usuario puede hacer login normalmente
- El banner es solo UX, no afecta funcionalidad

### Problema: Email no se pre-rellena en login

**Posibles causas:**
1. URL de success no tiene par√°metro email
2. create-checkout-session no fue actualizado

**Soluci√≥n:**
- Verificar que create-checkout-session incluye email en success_url
- Usuario puede escribir email manualmente

---

## üìû Soporte

Para problemas relacionados con este flujo:

1. **Revisar logs:** `auth_logs` tabla en Supabase
2. **Verificar webhook:** Stripe Dashboard > Webhooks > Logs
3. **Contactar:** dcprats@gmail.com con Session ID

---

## üîÑ Punto de Retorno

**Commit de backup:** `ec23262`

Para revertir estos cambios:

```bash
git reset --hard ec23262
```

**Archivos afectados:** 5 archivos modificados/creados

---

## ‚úÖ Checklist de Verificaci√≥n

Antes de considerar esta implementaci√≥n completa:

- [‚úÖ] Edge Function check-user-activation-status creada
- [‚úÖ] create-checkout-session incluye email en success_url
- [‚úÖ] PaymentSuccess implementa verificaci√≥n activa con polling
- [‚úÖ] LoginContainer detecta activaci√≥n reciente
- [‚úÖ] EmailInputForm soporta pre-relleno de email
- [‚úÖ] Documentaci√≥n completa creada
- [‚è≥] npm run build ejecutado sin errores
- [‚è≥] Edge Function desplegada en Supabase
- [‚è≥] Pruebas en ambiente de desarrollo
- [‚è≥] Pruebas en Stripe test mode

---

**FIN DE DOCUMENTACI√ìN**
